# PushSecret for ArgoCD TLS Certificate
#
# Automatically syncs the Let's Encrypt certificate from Kubernetes
# to OpenBao whenever cert-manager renews it.
#
# Flow:
#   cert-manager issues → argocd-server-tls-letsencrypt (K8s secret)
#                              ↓ (PushSecret watches)
#                         OpenBao secret/tls/argocd
#                              ↓ (ExternalSecret syncs)
#                         argocd-server-tls (used by ArgoCD)

apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: argocd-tls-to-openbao
  namespace: argocd
spec:
  # How often to check for changes
  refreshInterval: 1h

  # Reference to the secret store
  secretStoreRefs:
    - name: openbao
      kind: ClusterSecretStore

  # Which Kubernetes secret to push
  selector:
    secret:
      name: argocd-server-tls-letsencrypt

  # Where to push in OpenBao
  data:
    - match:
        secretKey: tls.crt
        remoteRef:
          remoteKey: secret/data/tls/argocd
          property: tls.crt
    - match:
        secretKey: tls.key
        remoteRef:
          remoteKey: secret/data/tls/argocd
          property: tls.key
