# ExternalSecret for cert-manager's Let's Encrypt certificate
#
# Restores the cert-manager managed secret from OpenBao on cluster recreation.
# This prevents cert-manager from requesting a new certificate - it sees
# the secret already exists and only renews when approaching expiry.
#
# Flow on cluster recreation:
#   1. ESO restores argocd-server-tls-letsencrypt from OpenBao
#   2. cert-manager sees secret exists â†’ no new issuance
#   3. cert-manager only renews when cert approaches expiry (renewBefore)

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: argocd-server-tls-letsencrypt
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao
  target:
    name: argocd-server-tls-letsencrypt
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
      metadata:
        annotations:
          # These annotations tell cert-manager this cert was issued by letsencrypt-prod
          cert-manager.io/certificate-name: argocd-server-tls-letsencrypt
          cert-manager.io/issuer-name: letsencrypt-prod
          cert-manager.io/issuer-kind: ClusterIssuer
          cert-manager.io/issuer-group: cert-manager.io
          cert-manager.io/common-name: ""
          cert-manager.io/alt-names: argocd.illmlab.xyz
      data:
        tls.crt: "{{ .cert }}"
        tls.key: "{{ .key }}"
  data:
    - secretKey: cert
      remoteRef:
        key: secret/data/tls/argocd
        property: tls.crt
    - secretKey: key
      remoteRef:
        key: secret/data/tls/argocd
        property: tls.key
