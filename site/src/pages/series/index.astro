---
import Base from '../../layouts/Base.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { loadAllExperiments, groupBySeries, groupExperiments, getAllTags, getDisplayTitle } from '../../lib/experiments';
import { loadSeries } from '../../lib/series';
import type { ExperimentGroup } from '../../lib/experiments';
import type { Series } from '../../lib/series';

const experiments = loadAllExperiments();
const seriesGroups = groupBySeries(experiments);
const allSeries = loadSeries();
const allGroups = groupExperiments(experiments);
const tags = getAllTags(experiments);
const base = import.meta.env.BASE_URL;

// Build tag -> experiment count map
const tagCounts: Record<string, number> = {};
for (const tag of tags) {
  tagCounts[tag] = allGroups.filter(g => g.tags.includes(tag)).length;
}

// Build tag -> experiment base names map for highlighting
const tagExperiments: Record<string, string[]> = {};
for (const tag of tags) {
  tagExperiments[tag] = allGroups.filter(g => g.tags.includes(tag)).map(g => g.baseName);
}

// Build series data with ordered experiments
interface SeriesEntry {
  series: Series;
  experiments: ExperimentGroup[];
}

const seriesEntries: SeriesEntry[] = allSeries.map(s => ({
  series: s,
  experiments: seriesGroups[s.id] ?? [],
}));

// Collect unsorted experiments (not in any series)
const seriesExpNames = new Set<string>();
for (const groups of Object.values(seriesGroups)) {
  for (const g of groups) {
    seriesExpNames.add(g.baseName);
  }
}
const unsorted = allGroups.filter(g => !seriesExpNames.has(g.baseName));
---

<Base title="Series â€” K8s Cloud TestBed">
  <Breadcrumb
    crumbs={[
      { label: 'Home', href: base },
      { label: 'Series' },
    ]}
    slot="breadcrumb"
  />

  <div class="tui-container" id="tui-root">
    <!-- CRT Scanline overlay -->
    <div class="crt-overlay" aria-hidden="true"></div>

    <div class="tui-layout">
      <!-- Left pane: Tag index -->
      <div class="tui-pane pane-tags" id="pane-tags" data-pane="tags">
        <div class="pane-header">
          <span class="pane-title">TAG INDEX</span>
          <span class="pane-count">{tags.length}</span>
        </div>
        <div class="pane-body" id="tag-list">
          {tags.map(tag => (
            <button
              class="tag-entry"
              data-tag={tag}
              data-experiments={JSON.stringify(tagExperiments[tag])}
            >
              <span class="tag-name">{tag}</span>
              <span class="tag-count">[{tagCounts[tag]}]</span>
            </button>
          ))}
        </div>
      </div>

      <!-- Center pane: Tree catalog -->
      <div class="tui-pane pane-tree" id="pane-tree" data-pane="tree">
        <div class="pane-header">
          <span class="pane-title">CATALOG</span>
          <span class="pane-count">{allGroups.length} experiments</span>
        </div>
        <div class="pane-body" id="tree-list">
          {seriesEntries.map(({ series, experiments: exps }) => (
            <div class="tree-series" data-series-id={series.id}>
              <div class="tree-series-header" style={`border-color: ${series.color || 'var(--border)'}`}>
                <span class="tree-branch" style={`color: ${series.color || 'var(--text-muted)'}`}>&#9484;&#9472;</span>
                <span class="tree-series-name" style={`color: ${series.color || 'var(--text)'}`}>{series.name}</span>
                <span class="tree-series-line" style={`border-color: ${series.color || 'var(--border)'}`}></span>
              </div>
              {exps.length === 0 ? (
                <div class="tree-row tree-empty">
                  <span class="tree-branch" style={`color: ${series.color || 'var(--text-muted)'}`}>&#9492;&#9472;&#9472;</span>
                  <span class="tree-exp-name muted">(coming soon)</span>
                </div>
              ) : (
                exps.map((group, i) => {
                  const isLast = i === exps.length - 1;
                  const branch = isLast ? '\u2514\u2500\u2500' : '\u251C\u2500\u2500';
                  const title = getDisplayTitle(group);
                  const runCount = group.runs.length;
                  return (
                    <a
                      href={`${base}experiments/${group.baseName}/`}
                      class="tree-row"
                      data-base-name={group.baseName}
                      data-tags={JSON.stringify(group.tags)}
                      data-title={title}
                      data-description={group.latest.description || ''}
                      data-runs={String(runCount)}
                      data-series={series.name}
                      data-series-color={series.color || ''}
                      data-phase={group.latest.phase || ''}
                    >
                      <span class="tree-branch" style={`color: ${series.color || 'var(--text-muted)'}`}>{branch}</span>
                      <span class="tree-exp-name">{title}</span>
                      <span class="tree-dots"></span>
                      <span class="tree-run-count">{runCount} {runCount === 1 ? 'run' : 'runs'}</span>
                    </a>
                  );
                })
              )}
              <div class="tree-spacer"></div>
            </div>
          ))}

          {unsorted.length > 0 && (
            <div class="tree-series" data-series-id="_unsorted">
              <div class="tree-series-header" style="border-color: var(--text-muted)">
                <span class="tree-branch" style="color: var(--text-muted)">&#9484;&#9472;</span>
                <span class="tree-series-name" style="color: var(--text-muted)">Unsorted</span>
                <span class="tree-series-line" style="border-color: var(--text-muted)"></span>
              </div>
              {unsorted.map((group, i) => {
                const isLast = i === unsorted.length - 1;
                const branch = isLast ? '\u2514\u2500\u2500' : '\u251C\u2500\u2500';
                const title = getDisplayTitle(group);
                const runCount = group.runs.length;
                return (
                  <a
                    href={`${base}experiments/${group.baseName}/`}
                    class="tree-row"
                    data-base-name={group.baseName}
                    data-tags={JSON.stringify(group.tags)}
                    data-title={title}
                    data-description={group.latest.description || ''}
                    data-runs={String(runCount)}
                    data-series="Unsorted"
                    data-series-color=""
                    data-phase={group.latest.phase || ''}
                  >
                    <span class="tree-branch" style="color: var(--text-muted)">{branch}</span>
                    <span class="tree-exp-name">{title}</span>
                    <span class="tree-dots"></span>
                    <span class="tree-run-count">{runCount} {runCount === 1 ? 'run' : 'runs'}</span>
                  </a>
                );
              })}
            </div>
          )}
        </div>
      </div>

      <!-- Right pane: Preview -->
      <div class="tui-pane pane-preview" id="pane-preview" data-pane="preview">
        <div class="pane-header">
          <span class="pane-title">PREVIEW</span>
        </div>
        <div class="pane-body" id="preview-content">
          <div class="preview-empty">
            <pre class="preview-ascii">{`  ____
 / ___| elect an
 \\___ \\ experiment
  ___) |to preview
 |____/`}</pre>
            <p class="preview-hint">Hover or navigate to an experiment in the catalog pane.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Status bar -->
    <div class="tui-status" id="tui-status">
      <span class="status-section">
        <span class="status-label">EXP</span>
        <span class="status-value">{allGroups.length}</span>
      </span>
      <span class="status-sep">|</span>
      <span class="status-section">
        <span class="status-label">SERIES</span>
        <span class="status-value">{allSeries.length}</span>
      </span>
      <span class="status-sep">|</span>
      <span class="status-section">
        <span class="status-label">RUNS</span>
        <span class="status-value">{experiments.length}</span>
      </span>
      <span class="status-sep">|</span>
      <span class="status-section">
        <span class="status-label">TAGS</span>
        <span class="status-value">{tags.length}</span>
      </span>
      <span class="status-fill"></span>
      <span class="status-section status-nav">
        <span class="status-key">Tab</span> pane
        <span class="status-key">&#8593;&#8595;</span> move
        <span class="status-key">Enter</span> open
      </span>
    </div>

    <!-- Mobile tabs -->
    <div class="mobile-tabs" id="mobile-tabs">
      <button class="mobile-tab active" data-target="tags">Tags</button>
      <button class="mobile-tab" data-target="tree">Catalog</button>
      <button class="mobile-tab" data-target="preview">Preview</button>
    </div>
  </div>
</Base>

<style>
  /* TUI Container */
  .tui-container {
    position: relative;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    line-height: 1.4;
    min-height: 70vh;
    display: flex;
    flex-direction: column;
  }

  /* CRT Scanline overlay */
  .crt-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 10;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0, 0, 0, 0.03) 2px,
      rgba(0, 0, 0, 0.03) 4px
    );
  }

  /* Three-pane layout */
  .tui-layout {
    display: grid;
    grid-template-columns: minmax(140px, 1fr) minmax(280px, 2.5fr) minmax(180px, 1.5fr);
    flex: 1;
    min-height: 0;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  /* Pane base */
  .tui-pane {
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
  }

  .tui-pane + .tui-pane {
    border-left: 1px solid var(--border);
  }

  .pane-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.35rem 0.5rem;
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    user-select: none;
  }

  .pane-title {
    font-weight: 700;
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .pane-count {
    font-size: 0.65rem;
    color: var(--text-muted);
  }

  .pane-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0.25rem 0;
  }

  /* Scrollbar styling */
  .pane-body::-webkit-scrollbar {
    width: 4px;
  }

  .pane-body::-webkit-scrollbar-track {
    background: transparent;
  }

  .pane-body::-webkit-scrollbar-thumb {
    background: var(--border);
  }

  /* ---- TAG INDEX (left pane) ---- */
  .tag-entry {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    width: 100%;
    padding: 0.15rem 0.5rem;
    background: none;
    border: none;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    cursor: pointer;
    text-align: left;
    transition: background 0.1s, color 0.1s;
  }

  .tag-entry:hover,
  .tag-entry.active {
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
  }

  .tag-entry.active {
    background: color-mix(in srgb, var(--accent) 20%, transparent);
    font-weight: 600;
  }

  .tag-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-right: 0.25rem;
  }

  .tag-count {
    flex-shrink: 0;
    font-size: 0.65rem;
    opacity: 0.7;
  }

  /* ---- TREE CATALOG (center pane) ---- */
  .tree-series {
    margin-bottom: 0;
  }

  .tree-series-header {
    display: flex;
    align-items: center;
    padding: 0.35rem 0.5rem 0.1rem;
    gap: 0.35rem;
    user-select: none;
  }

  .tree-series-name {
    font-weight: 700;
    font-size: 0.8rem;
    letter-spacing: 0.02em;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .tree-series-line {
    flex: 1;
    border-bottom: 1px dashed;
    opacity: 0.3;
    min-width: 1rem;
  }

  .tree-branch {
    flex-shrink: 0;
    white-space: pre;
    font-size: 0.8rem;
    line-height: 1;
  }

  .tree-row {
    display: flex;
    align-items: baseline;
    padding: 0.12rem 0.5rem 0.12rem 0.75rem;
    gap: 0.25rem;
    color: var(--text);
    text-decoration: none;
    cursor: pointer;
    transition: background 0.1s;
    min-height: 1.4em;
  }

  a.tree-row:hover {
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    color: var(--text);
    text-decoration: none;
  }

  .tree-row.selected {
    background: color-mix(in srgb, var(--accent) 18%, transparent);
  }

  .tree-row.tag-highlight {
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .tree-row.tag-highlight.selected {
    background: color-mix(in srgb, var(--accent) 22%, transparent);
  }

  .tree-row.tag-dim {
    opacity: 0.35;
  }

  .tree-exp-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-shrink: 1;
    min-width: 0;
  }

  .tree-exp-name.muted {
    color: var(--text-muted);
    font-style: italic;
  }

  .tree-dots {
    flex: 1;
    min-width: 0.5rem;
    border-bottom: 1px dotted var(--border);
    margin-bottom: 0.2em;
    opacity: 0.5;
  }

  .tree-run-count {
    flex-shrink: 0;
    color: var(--text-muted);
    font-size: 0.7rem;
    white-space: nowrap;
  }

  .tree-empty {
    cursor: default;
  }

  .tree-empty:hover {
    background: none;
  }

  .tree-spacer {
    height: 0.35rem;
  }

  /* ---- PREVIEW PANE (right pane) ---- */
  .preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 1rem;
    color: var(--text-muted);
    text-align: center;
  }

  .preview-ascii {
    font-size: 0.7rem;
    line-height: 1.2;
    color: var(--border);
    margin-bottom: 0.75rem;
    white-space: pre;
  }

  .preview-hint {
    font-size: 0.7rem;
    opacity: 0.6;
  }

  #preview-content {
    padding: 0;
  }

  :global(.preview-detail) {
    padding: 0.5rem;
  }

  :global(.preview-title) {
    font-family: var(--font-mono);
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--text);
    margin-bottom: 0.35rem;
    line-height: 1.3;
  }

  :global(.preview-series) {
    font-size: 0.7rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  :global(.preview-series-dot) {
    display: inline-block;
    width: 6px;
    height: 6px;
    flex-shrink: 0;
  }

  :global(.preview-series-name) {
    font-family: var(--font-mono);
    color: var(--text-muted);
  }

  :global(.preview-description) {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 0.5rem;
    max-height: 6rem;
    overflow: hidden;
  }

  :global(.preview-meta) {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin-bottom: 0.5rem;
    padding: 0.35rem;
    border: 1px solid var(--border);
  }

  :global(.preview-meta-row) {
    display: flex;
    justify-content: space-between;
    font-family: var(--font-mono);
    font-size: 0.7rem;
  }

  :global(.preview-meta-label) {
    color: var(--text-muted);
  }

  :global(.preview-meta-value) {
    color: var(--text);
    font-weight: 600;
  }

  :global(.preview-tags) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.35rem;
  }

  :global(.preview-tag) {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    padding: 0.05rem 0.35rem;
    border: 1px solid var(--border);
    color: var(--text-muted);
  }

  /* ---- STATUS BAR ---- */
  .tui-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-top: none;
    font-size: 0.65rem;
    color: var(--text-muted);
    flex-shrink: 0;
    user-select: none;
  }

  .status-section {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .status-label {
    font-weight: 700;
    letter-spacing: 0.05em;
    font-size: 0.6rem;
  }

  .status-value {
    color: var(--text);
  }

  .status-sep {
    color: var(--border);
  }

  .status-fill {
    flex: 1;
  }

  .status-nav {
    gap: 0.5rem;
  }

  .status-key {
    display: inline-block;
    padding: 0 0.25rem;
    border: 1px solid var(--border);
    font-size: 0.6rem;
    line-height: 1.4;
    color: var(--text);
  }

  /* ---- MOBILE TABS ---- */
  .mobile-tabs {
    display: none;
    border: 1px solid var(--border);
    border-top: none;
  }

  .mobile-tab {
    flex: 1;
    padding: 0.4rem;
    background: var(--bg-surface);
    border: none;
    border-right: 1px solid var(--border);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--text-muted);
    cursor: pointer;
    font-weight: 600;
    letter-spacing: 0.03em;
  }

  .mobile-tab:last-child {
    border-right: none;
  }

  .mobile-tab.active {
    background: color-mix(in srgb, var(--accent) 15%, transparent);
    color: var(--accent);
  }

  /* Active pane indicator */
  .tui-pane.pane-active > .pane-header {
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .tui-pane.pane-active > .pane-header .pane-title {
    color: var(--accent);
  }

  /* ---- RESPONSIVE ---- */
  @media (max-width: 768px) {
    .tui-layout {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
    }

    .tui-pane {
      display: none;
    }

    .tui-pane.mobile-visible {
      display: flex;
    }

    .tui-pane + .tui-pane {
      border-left: none;
      border-top: 1px solid var(--border);
    }

    .mobile-tabs {
      display: flex;
    }

    .status-nav {
      display: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const treeRows = Array.from(document.querySelectorAll<HTMLAnchorElement>('a.tree-row'));
    const tagEntries = Array.from(document.querySelectorAll<HTMLButtonElement>('.tag-entry'));
    const previewContent = document.getElementById('preview-content');
    const panes = Array.from(document.querySelectorAll<HTMLDivElement>('.tui-pane'));
    const mobileTabs = Array.from(document.querySelectorAll<HTMLButtonElement>('.mobile-tab'));

    let selectedIndex = -1;
    let activeTag: string | null = null;
    let activePaneIndex = 1; // center pane by default

    // --- Pane focus ---
    function setActivePane(index: number) {
      activePaneIndex = index;
      panes.forEach((p, i) => p.classList.toggle('pane-active', i === index));
    }
    setActivePane(1);

    // --- Mobile tabs ---
    function showMobilePane(target: string) {
      panes.forEach(p => {
        p.classList.toggle('mobile-visible', p.dataset.pane === target);
      });
      mobileTabs.forEach(t => {
        t.classList.toggle('active', t.dataset.target === target);
      });
    }

    // Default mobile pane
    showMobilePane('tags');

    mobileTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        showMobilePane(tab.dataset.target || 'tree');
      });
    });

    // --- HTML escaping ---
    function escapeHtml(str: string): string {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // --- Preview update ---
    function updatePreview(row: HTMLAnchorElement) {
      if (!previewContent) return;

      const title = row.dataset.title || '';
      const description = row.dataset.description || '';
      const runs = row.dataset.runs || '0';
      const series = row.dataset.series || '';
      const seriesColor = row.dataset.seriesColor || '';
      const phase = row.dataset.phase || '';
      const tags: string[] = JSON.parse(row.dataset.tags || '[]');

      let tagsHtml = '';
      if (tags.length > 0) {
        tagsHtml = '<div class="preview-tags">' +
          tags.map(t => `<span class="preview-tag">${escapeHtml(t)}</span>`).join('') +
          '</div>';
      }

      const dotColor = seriesColor ? `background:${seriesColor}` : 'background:var(--text-muted)';

      previewContent.innerHTML = `
        <div class="preview-detail">
          <div class="preview-title">${escapeHtml(title)}</div>
          <div class="preview-series">
            <span class="preview-series-dot" style="${dotColor}"></span>
            <span class="preview-series-name">${escapeHtml(series)}</span>
          </div>
          ${description ? `<div class="preview-description">${escapeHtml(description)}</div>` : ''}
          <div class="preview-meta">
            <div class="preview-meta-row">
              <span class="preview-meta-label">Runs</span>
              <span class="preview-meta-value">${escapeHtml(runs)}</span>
            </div>
            <div class="preview-meta-row">
              <span class="preview-meta-label">Phase</span>
              <span class="preview-meta-value">${escapeHtml(phase || 'N/A')}</span>
            </div>
            <div class="preview-meta-row">
              <span class="preview-meta-label">Tags</span>
              <span class="preview-meta-value">${tags.length}</span>
            </div>
          </div>
          ${tagsHtml}
        </div>
      `;
    }

    function clearPreview() {
      if (!previewContent) return;
      previewContent.innerHTML = `
        <div class="preview-empty">
          <pre class="preview-ascii">  ____
 / ___| elect an
 \\___ \\ experiment
  ___) |to preview
 |____/</pre>
          <p class="preview-hint">Hover or navigate to an experiment in the catalog pane.</p>
        </div>
      `;
    }

    // --- Selection ---
    function selectRow(index: number) {
      if (index < 0 || index >= treeRows.length) return;
      treeRows.forEach(r => r.classList.remove('selected'));
      selectedIndex = index;
      treeRows[index].classList.add('selected');
      treeRows[index].scrollIntoView({ block: 'nearest' });
      updatePreview(treeRows[index]);
    }

    // --- Hover ---
    treeRows.forEach((row, i) => {
      row.addEventListener('mouseenter', () => {
        selectedIndex = i;
        treeRows.forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
        updatePreview(row);
      });
    });

    // --- Tag filtering ---
    tagEntries.forEach(entry => {
      entry.addEventListener('click', () => {
        const tag = entry.dataset.tag || '';
        const experiments: string[] = JSON.parse(entry.dataset.experiments || '[]');

        if (activeTag === tag) {
          // Deselect
          activeTag = null;
          tagEntries.forEach(e => e.classList.remove('active'));
          treeRows.forEach(r => {
            r.classList.remove('tag-highlight', 'tag-dim');
          });
        } else {
          // Select
          activeTag = tag;
          tagEntries.forEach(e => e.classList.toggle('active', e.dataset.tag === tag));
          treeRows.forEach(r => {
            const baseName = r.dataset.baseName || '';
            if (experiments.includes(baseName)) {
              r.classList.add('tag-highlight');
              r.classList.remove('tag-dim');
            } else {
              r.classList.remove('tag-highlight');
              r.classList.add('tag-dim');
            }
          });
        }
      });
    });

    // --- Keyboard navigation ---
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      // Don't capture if user is typing in an input
      const target = e.target as HTMLElement;
      if (target?.tagName === 'INPUT' || target?.tagName === 'TEXTAREA') return;

      // Tab switches panes
      if (e.key === 'Tab') {
        e.preventDefault();
        activePaneIndex = (activePaneIndex + 1) % 3;
        setActivePane(activePaneIndex);
        return;
      }

      // Arrow keys navigate center pane
      if (activePaneIndex === 1) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectRow(selectedIndex < 0 ? 0 : Math.min(selectedIndex + 1, treeRows.length - 1));
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectRow(selectedIndex <= 0 ? 0 : selectedIndex - 1);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          window.location.href = treeRows[selectedIndex].href;
        }
      }

      // Arrow keys navigate tag pane
      if (activePaneIndex === 0) {
        const currentActiveIdx = tagEntries.findIndex(el => el.classList.contains('active'));
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const next = currentActiveIdx < 0 ? 0 : Math.min(currentActiveIdx + 1, tagEntries.length - 1);
          tagEntries[next].click();
          tagEntries[next].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          const prev = currentActiveIdx <= 0 ? 0 : currentActiveIdx - 1;
          tagEntries[prev].click();
          tagEntries[prev].scrollIntoView({ block: 'nearest' });
        }
      }
    });
  });
</script>
