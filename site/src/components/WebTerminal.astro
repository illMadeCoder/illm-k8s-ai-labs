---
interface Props {
  terminalUrl?: string;
}

const { terminalUrl } = Astro.props;
---

<div class="web-terminal" data-terminal-url={terminalUrl || ''}>
  <div class="terminal-header">
    <div class="terminal-dots">
      <span class="terminal-dot dot-red"></span>
      <span class="terminal-dot dot-yellow"></span>
      <span class="terminal-dot dot-green"></span>
    </div>
    <span class="terminal-title">Web Terminal</span>
    <button class="terminal-toggle" id="terminal-toggle-btn">
      {terminalUrl ? 'Connect' : 'Requires running experiment'}
    </button>
  </div>
  <div class="terminal-body" id="terminal-container" style="display:none">
    <div id="terminal-element"></div>
  </div>
</div>

<script is:inline>
  (function() {
    var container = document.querySelector('.web-terminal');
    if (!container) return;
    var url = container.getAttribute('data-terminal-url');
    var btn = document.getElementById('terminal-toggle-btn');
    var body = document.getElementById('terminal-container');
    var el = document.getElementById('terminal-element');
    if (!btn || !body || !el) return;

    var connected = false;
    var term = null;
    var ws = null;

    if (!url) {
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'default';
      return;
    }

    btn.addEventListener('click', function() {
      if (connected) {
        // Disconnect
        if (ws) ws.close();
        if (term) term.dispose();
        body.style.display = 'none';
        btn.textContent = 'Connect';
        connected = false;
        return;
      }

      body.style.display = 'block';
      btn.textContent = 'Connecting...';

      // Load xterm.js from CDN
      if (!window.Terminal) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5/css/xterm.min.css';
        document.head.appendChild(link);

        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5/lib/xterm.min.js';
        script.onload = function() {
          var fitScript = document.createElement('script');
          fitScript.src = 'https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0/lib/addon-fit.min.js';
          fitScript.onload = function() { initTerminal(); };
          document.head.appendChild(fitScript);
        };
        document.head.appendChild(script);
      } else {
        initTerminal();
      }
    });

    function initTerminal() {
      term = new window.Terminal({
        fontFamily: 'JetBrains Mono, Fira Code, monospace',
        fontSize: 14,
        theme: {
          background: '#1a1a2e',
          foreground: '#e2e8f0',
          cursor: '#e879f9',
          selectionBackground: 'rgba(232, 121, 249, 0.3)',
        },
        cursorBlink: true,
      });

      var fitAddon = new window.FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(el);
      fitAddon.fit();

      ws = new WebSocket(url);
      ws.binaryType = 'arraybuffer';

      ws.onopen = function() {
        btn.textContent = 'Disconnect';
        connected = true;
        term.focus();
      };

      ws.onmessage = function(e) {
        if (e.data instanceof ArrayBuffer) {
          term.write(new Uint8Array(e.data));
        } else {
          term.write(e.data);
        }
      };

      ws.onclose = function() {
        term.write('\r\n\x1b[90m[Connection closed]\x1b[0m\r\n');
        btn.textContent = 'Reconnect';
        connected = false;
      };

      ws.onerror = function() {
        term.write('\r\n\x1b[31m[Connection error]\x1b[0m\r\n');
        btn.textContent = 'Reconnect';
        connected = false;
      };

      term.onData(function(data) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(data);
        }
      });

      window.addEventListener('resize', function() { fitAddon.fit(); });
    }
  })();
</script>

<style>
  .web-terminal {
    border: 1px solid #2d2d4a;
    border-radius: var(--radius);
    overflow: hidden;
    background: #1a1a2e;
    margin: 0.75rem 1rem;
  }

  .terminal-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: #151528;
    border-bottom: 1px solid #2d2d4a;
  }

  .terminal-dots {
    display: flex;
    gap: 0.35rem;
  }

  .terminal-dot {
    width: 0.6rem;
    height: 0.6rem;
    border-radius: 50%;
  }

  .dot-red { background: #ef4444; }
  .dot-yellow { background: #eab308; }
  .dot-green { background: #22c55e; }

  .terminal-title {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: #64748b;
    flex: 1;
  }

  .terminal-toggle {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 600;
    color: #e879f9;
    background: color-mix(in srgb, #e879f9 12%, transparent);
    border: 1px solid color-mix(in srgb, #e879f9 25%, transparent);
    border-radius: 4px;
    padding: 0.25rem 0.6rem;
    cursor: pointer;
    transition: background 0.15s;
  }

  .terminal-toggle:hover {
    background: color-mix(in srgb, #e879f9 20%, transparent);
  }

  .terminal-body {
    min-height: 300px;
    padding: 0.5rem;
  }

  #terminal-element {
    height: 300px;
  }

  @media (max-width: 640px) {
    .web-terminal {
      margin: 0.5rem 0.75rem;
    }

    .terminal-body {
      min-height: 200px;
    }

    #terminal-element {
      height: 200px;
    }
  }
</style>
