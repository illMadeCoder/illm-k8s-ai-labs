apiVersion: batch/v1
kind: Job
metadata:
  name: naive-db-debug-scrape
  labels:
    app: naive-db-debug
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: naive-db-debug
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-prom
          image: curlimages/curl:8.5.0
          command: [sh, -c]
          args:
            - |
              echo "Waiting for Prometheus to be ready..."
              for i in $(seq 1 60); do
                if curl -sf http://kube-prometheus-stack-prometheus:9090/-/ready >/dev/null 2>&1; then
                  echo "Prometheus is ready"
                  exit 0
                fi
                sleep 5
              done
              echo "Prometheus not ready after 5 minutes"
              exit 1
      containers:
        - name: debug
          image: curlimages/curl:8.5.0
          command: [sh, -c]
          args:
            - |
              set -e
              echo "=== 1. Direct naive-db /metrics check ==="
              echo "Fetching http://naive-db/metrics..."
              metrics=$(curl -sf http://naive-db/metrics 2>&1) || echo "FAILED to fetch metrics: $?"
              echo "$metrics" | head -20
              echo "---"
              naivedb_count=$(echo "$metrics" | grep -c "^naivedb_" || true)
              echo "naivedb_* lines: $naivedb_count"
              echo ""

              echo "=== 2. Direct naive-db pod IP /metrics check ==="
              # Try pod IP directly (same as what Prometheus does)
              POD_IP=$(echo "$metrics" | head -1 | grep -o 'nothing' || true)
              echo "Trying naive-db-0 pod via DNS..."
              curl -sf http://naive-db-0.naive-db:8080/metrics 2>&1 | head -5 || echo "FAILED via StatefulSet DNS"
              echo ""

              echo "=== 3. Prometheus scrape targets ==="
              echo "Fetching Prometheus targets API..."
              targets=$(curl -sf "http://kube-prometheus-stack-prometheus:9090/api/v1/targets" 2>&1)
              echo "$targets" | python3 -c "
              import sys, json
              try:
                  d = json.load(sys.stdin)
                  for t in d.get('data', {}).get('activeTargets', []):
                      job = t.get('labels', {}).get('job', 'unknown')
                      health = t.get('health', 'unknown')
                      url = t.get('scrapeUrl', 'unknown')
                      error = t.get('lastError', '')
                      print(f'  {job}: health={health} url={url}')
                      if error:
                          print(f'    ERROR: {error}')
              except Exception as e:
                  print(f'Parse error: {e}')
              " 2>/dev/null || echo "$targets" | head -50
              echo ""

              echo "=== 4. Prometheus config (scrape section) ==="
              curl -sf "http://kube-prometheus-stack-prometheus:9090/api/v1/status/config" 2>&1 | python3 -c "
              import sys, json
              try:
                  d = json.load(sys.stdin)
                  config = d.get('data', {}).get('yaml', '')
                  # Find naive-db scrape config
                  lines = config.split('\n')
                  in_naivedb = False
                  for line in lines:
                      if 'naive-db' in line or 'naive_db' in line:
                          in_naivedb = True
                      if in_naivedb:
                          print(line)
                          if line.strip() == '' or (line.startswith('- job_name') and 'naive' not in line):
                              break
              except Exception as e:
                  print(f'Parse error: {e}')
              " 2>/dev/null || echo "Failed to get config"
              echo ""

              echo "=== 5. Simple Prometheus queries ==="
              echo "up{job=naive-db}:"
              curl -sf "http://kube-prometheus-stack-prometheus:9090/api/v1/query?query=up%7Bjob%3D%22naive-db%22%7D" 2>&1 | head -5
              echo ""
              echo "naivedb_rows_total:"
              curl -sf "http://kube-prometheus-stack-prometheus:9090/api/v1/query?query=naivedb_rows_total" 2>&1 | head -5
              echo ""
              echo "count(up):"
              curl -sf "http://kube-prometheus-stack-prometheus:9090/api/v1/query?query=count(up)" 2>&1 | head -5
              echo ""

              echo "=== Debug complete ==="
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
