# Gateway Comparison v2 — Validation + Phased Observation Workflow
# 3 steps: smoke-test → wait-gateways → observe (40min with idle/load/cooldown phases)
# Total duration: ~46 min
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: gateway-comparison-validation
  namespace: argo-workflows
spec:
  arguments:
    parameters:
      - name: experiment-name
        value: ""
      - name: target-endpoint
        value: ""
      - name: target-name
        value: ""
      - name: app-endpoint
        value: ""
      - name: app-name
        value: ""
      - name: loadgen-endpoint
        value: ""
      - name: loadgen-name
        value: ""
  entrypoint: validate-and-observe
  serviceAccountName: argo-workflow
  templates:
    - name: validate-and-observe
      steps:
        - - name: smoke-test
            template: check-target
        - - name: wait-gateways
            template: wait-for-gateways
        - - name: observe
            template: phased-observation

    - name: check-target
      container:
        image: curlimages/curl:8.5.0
        command: [sh, -c]
        args:
          - |
            ENDPOINT="{{workflow.parameters.app-endpoint}}"
            # Fall back to generic target-endpoint for backward compat
            if [ -z "${ENDPOINT}" ]; then
              ENDPOINT="{{workflow.parameters.target-endpoint}}"
            fi
            EXP="{{workflow.parameters.experiment-name}}"
            echo "=== Gateway Comparison v2: ${EXP} ==="
            echo "App endpoint: ${ENDPOINT}"

            if [ -z "${ENDPOINT}" ]; then
              echo "No target endpoint, skipping check"
              exit 0
            fi

            echo "Checking app cluster API server..."
            HTTP_CODE=$(curl -sk -o /dev/null -w '%{http_code}' --connect-timeout 10 "https://${ENDPOINT}/livez" || true)
            echo "API server /livez returned: ${HTTP_CODE}"

            if [ "${HTTP_CODE}" = "401" ] || [ "${HTTP_CODE}" = "403" ] || [ "${HTTP_CODE}" = "200" ]; then
              echo "App cluster is reachable (HTTP ${HTTP_CODE})"
            else
              echo "WARNING: Could not reach app cluster (HTTP ${HTTP_CODE}) — may be transient"
            fi

            echo "Smoke test passed — ArgoCD has already deployed all components"

    - name: wait-for-gateways
      container:
        image: busybox:1.36
        command: [sh, -c]
        args:
          - |
            EXP="{{workflow.parameters.experiment-name}}"
            echo "========================================="
            echo "  WAITING FOR GATEWAY SYNC: ${EXP}"
            echo "  Polling every 30s for up to 5 minutes"
            echo "  Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "========================================="

            # Give ArgoCD time to sync all gateway components
            # (nginx-ingress, traefik, envoy-gateway, demo apps, routes)
            ATTEMPTS=10
            for i in $(seq 1 $ATTEMPTS); do
              echo "[$(date -u +%H:%M:%S)] Wait cycle $i/$ATTEMPTS..."
              sleep 30
            done

            echo "========================================="
            echo "  GATEWAY SYNC WAIT COMPLETE"
            echo "  End: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "========================================="

    - name: phased-observation
      container:
        image: busybox:1.36
        command: [sh, -c]
        args:
          - |
            EXP="{{workflow.parameters.experiment-name}}"
            echo "========================================="
            echo "  PHASED OBSERVATION: ${EXP}"
            echo "  Total duration: 40 minutes"
            echo "  Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "========================================="
            echo ""

            # Phase 1: Idle baseline (0-10 min)
            echo ">>> PHASE 1: IDLE BASELINE (0-10 min)"
            echo ">>> Observing: NGINX Ingress, Traefik, Envoy Gateway"
            echo ">>> Purpose: Capture idle resource footprint before load"
            echo ">>> k6 init container is discovering gateway endpoints on loadgen cluster..."
            echo ">>> Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            sleep 600
            echo ">>> PHASE 1 COMPLETE: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""

            # Phase 2: Load test period (10-30 min)
            echo ">>> PHASE 2: LOAD TEST PERIOD (10-30 min)"
            echo ">>> k6 Job running independently on loadgen cluster"
            echo ">>> Load profile: warmup 1VU → ramp 10VU → hold → ramp 50VU → hold → cooldown"
            echo ">>> k6 duration: ~16 min (started after 10min idle baseline)"
            echo ">>> Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            sleep 1200
            echo ">>> PHASE 2 COMPLETE: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""

            # Phase 3: Post-load cooldown (30-40 min)
            echo ">>> PHASE 3: POST-LOAD COOLDOWN (30-40 min)"
            echo ">>> Purpose: Observe resource release and steady-state recovery"
            echo ">>> Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            sleep 600
            echo ">>> PHASE 3 COMPLETE: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""

            echo "========================================="
            echo "  OBSERVATION COMPLETE"
            echo "  End: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "========================================="
