# Part 4: TLS Configuration and Multi-Gateway Patterns
---
# Part 4k: TLS Certificate from OpenBao
#
# The certificate is stored in OpenBao and synced via ExternalSecret.
# To generate and store a self-signed certificate:
#
#   # Generate cert
#   openssl req -x509 -newkey rsa:4096 -sha256 -days 365 -nodes \
#     -keyout tls.key -out tls.crt \
#     -subj "/CN=*.gateway.local" \
#     -addext "subjectAltName=DNS:*.gateway.local,DNS:gateway.local"
#
#   # Store in OpenBao
#   bao kv put secret/tls/gateway-tutorial \
#     tls.crt=@tls.crt \
#     tls.key=@tls.key
#
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: tutorial-tls-cert
  namespace: gateway-tutorial
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao
  target:
    name: tutorial-tls-cert
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
      data:
        tls.crt: "{{ .cert }}"
        tls.key: "{{ .key }}"
  data:
    - secretKey: cert
      remoteRef:
        key: secret/data/tls/gateway-tutorial
        property: tls.crt
    - secretKey: key
      remoteRef:
        key: secret/data/tls/gateway-tutorial
        property: tls.key
---
# Part 4l: TLS Termination - Gateway terminates TLS
# This is the most common pattern
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: tls-termination-gateway
  namespace: gateway-tutorial
spec:
  gatewayClassName: eg
  listeners:
    - name: https
      protocol: HTTPS
      port: 443
      tls:
        mode: Terminate
        certificateRefs:
          - name: tutorial-tls-cert
      allowedRoutes:
        namespaces:
          from: Same
---
# Part 4m: TLS Passthrough - Gateway passes encrypted traffic to backend
# Backend must handle TLS termination
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: tls-passthrough-gateway
  namespace: gateway-tutorial
spec:
  gatewayClassName: eg
  listeners:
    - name: tls-passthrough
      protocol: TLS
      port: 8443
      tls:
        mode: Passthrough
      allowedRoutes:
        namespaces:
          from: Same
---
# TLSRoute for passthrough (routes based on SNI)
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TLSRoute
metadata:
  name: tls-passthrough-route
  namespace: gateway-tutorial
spec:
  parentRefs:
    - name: tls-passthrough-gateway
      sectionName: tls-passthrough
  hostnames:
    - "passthrough.gateway.local"
  rules:
    - backendRefs:
        - name: api-service
          port: 80
---
# Part 4n: Multi-Gateway Pattern - Internal vs External
# External gateway for public traffic
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: external-gateway
  namespace: gateway-tutorial
  annotations:
    description: "Public-facing gateway with stricter security"
spec:
  gatewayClassName: eg
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Same
---
# Internal gateway for service-to-service traffic
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: internal-gateway
  namespace: gateway-tutorial
  annotations:
    description: "Internal gateway for cluster traffic"
spec:
  gatewayClassName: eg
  listeners:
    - name: http
      protocol: HTTP
      port: 8080
      allowedRoutes:
        namespaces:
          from: All  # Allow routes from any namespace
---
# Part 4o: ReferenceGrant - Cross-namespace routing
# Allow routes in other namespaces to reference services in gateway-tutorial
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-cross-namespace
  namespace: gateway-tutorial
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: other-namespace  # Allow routes from other-namespace
  to:
    - group: ""
      kind: Service
---
# Route attached to external gateway
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: external-api
  namespace: gateway-tutorial
spec:
  parentRefs:
    - name: external-gateway
  hostnames:
    - "api.public.gateway.local"
  rules:
    - backendRefs:
        - name: api-service
          port: 80
---
# Route attached to internal gateway
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: internal-api
  namespace: gateway-tutorial
spec:
  parentRefs:
    - name: internal-gateway
  hostnames:
    - "api.internal.gateway.local"
  rules:
    - backendRefs:
        - name: api-service
          port: 80
