# ExternalSecret for Talos Cluster Registration
#
# Syncs the Talos cluster credentials from OpenBao to ArgoCD.
# This allows the cluster registration to persist across hub cluster recreations.

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cluster-talos-target
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao
  target:
    name: cluster-talos-target
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: cluster
      data:
        name: "{{ .name }}"
        server: "{{ .server }}"
        config: |
          {
            "tlsClientConfig": {
              "caData": "{{ .caData }}",
              "certData": "{{ .certData }}",
              "keyData": "{{ .keyData }}"
            }
          }
  data:
    - secretKey: name
      remoteRef:
        key: clusters/talos-target
        property: name
    - secretKey: server
      remoteRef:
        key: clusters/talos-target
        property: server
    - secretKey: caData
      remoteRef:
        key: clusters/talos-target
        property: caData
    - secretKey: certData
      remoteRef:
        key: clusters/talos-target
        property: certData
    - secretKey: keyData
      remoteRef:
        key: clusters/talos-target
        property: keyData
